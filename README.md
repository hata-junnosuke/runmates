# Runmates - ランニング管理アプリケーション

フルスタックのランニング記録管理アプリケーションです。Rails APIバックエンドとNext.jsフロントエンドを使用し、Dockerでコンテナ化されています。包括的なランニング記録の追跡、目標設定、データ可視化機能を提供します。

## 技術スタック

**Backend**
- Rails API (Ruby 3.4.3)
- MySQL 8.0.32
- DeviseTokenAuth（HTTP-onlyクッキー認証）

**Frontend**
- Next.js 15.3.1 with TypeScript
- Tailwind CSS
- Material-UI (MUI)
- Chart.js + react-chartjs-2

**Infrastructure**
- Docker & Docker Compose
- AWS ECS Fargate (本番環境)
- Nginx リバースプロキシ

## 主要機能

- カレンダーインターフェースによるランニング記録管理
- 月間・年間目標設定と達成状況の追跡
- インタラクティブなデータ可視化とプログレスチャート
- レスポンシブUIとモダンなデザインパターン

## 開発環境セットアップ

### 初回セットアップ

```bash
# リポジトリをクローンしてコンテナをビルド
docker compose build --no-cache
docker compose up

# フロントエンドセットアップ（新しいターミナルで実行）
docker compose exec next /bin/bash
npm i
npm run dev  # localhost:8000でアクセス可能

# バックエンドセットアップ（新しいターミナルで実行）
docker compose run --rm rails bundle install
docker compose exec rails /bin/bash
rails s -b '0.0.0.0'  # localhost:3000でアクセス可能
```

### 日常的な開発コマンド

**重要: 全てのコマンドはDockerコンテナ内で実行してください**

#### フロントエンドコマンド
```bash
docker-compose exec next npm run dev          # 開発サーバー起動（Turbopack使用）
docker-compose exec next npm run build        # プロダクションビルド
docker-compose exec next npm run lint         # ESLintチェック
docker-compose exec next npm run format       # リント問題の自動修正
```

#### バックエンドコマンド
```bash
docker-compose exec rails rails s -b '0.0.0.0' # サーバー起動（Docker用）
docker-compose exec rails bundle exec rspec    # 全テスト実行
docker-compose exec rails bundle exec rubocop  # コードスタイルチェック
docker-compose exec rails rails db:migrate     # データベースマイグレーション
docker-compose exec rails rails console        # Rails コンソール
```

### テスト実行

```bash
# バックエンドテスト（Rails）
docker-compose exec rails bundle exec rspec                    # 全テスト
docker-compose exec rails bundle exec rspec spec/models/       # モデルテストのみ
docker-compose exec rails bundle exec rspec spec/requests/     # API/リクエストテストのみ
docker-compose exec rails bundle exec rspec --format documentation  # 詳細出力

# フロントエンドテストは現在未設定
```

## アーキテクチャ概要

### 認証フロー
1. ユーザーがReactフォーム（SignInForm/SignUpForm）で認証情報を送信
2. フロントエンドがRails API（`/api/v1/auth/`）にリクエスト送信
3. Railsが認証情報を検証し、DeviseTokenAuthトークンを生成
4. RailsがHTTP-onlyクッキーに`access-token`、`client`、`uid`を設定
5. 以降のリクエストでクッキーが自動的に含まれる
6. Railsが保護されたルートでクッキーからトークンを検証

**重要**: 認証にはクッキーを使用し、localStorageは使用しません。XSS攻撃防止のためトークンはHTTP-onlyです。

### API構造
- 全APIエンドポイントは`/api/v1/`名前空間下
- ルートは`rails/config/routes.rb`で定義
- コントローラーは`rails/app/controllers/api/v1/`
- JSON レスポンス用シリアライザーは`rails/app/serializers/`

### データベース設計
- MySQL データベースによる包括的なランニング管理スキーマ:
  - `users` - DeviseTokenAuth管理のユーザーアカウント
  - `running_records` - 日次ランニング距離記録
  - `monthly_goals` - 年月制約付き月間距離目標
  - `yearly_goals` - 一意制約付き年間距離目標
- データベースはDockerコンテナ内でポート3307で稼働
- マイグレーションは`rails/db/migrate/`
- テストデータファクトリーは`rails/spec/factories/`

## 環境設定

### 開発環境
- Railsサーバー: localhost:3000
- Next.jsフロントエンド: localhost:8000
- MySQLデータベース: localhost:3307
- クッキー設定: `same_site: :lax`, `secure: false`

**環境変数（.env.development）:**
```bash
# Frontend
NEXT_PUBLIC_API_URL=http://localhost:3000/api/v1
INTERNAL_API_URL=http://host.docker.internal:3000/api/v1
NEXT_PUBLIC_BASE_URL=http://localhost:8000

# Backend (Rails)
MYSQL_DATABASE=runmates_development
DEVISE_SECRET_KEY=<auto-generated>
```

### 本番環境
- ドメイン: `runmates.net`
- クッキー設定: `same_site: :none`, `secure: true`
- AWS ECS Fargateにデプロイ
- Nginxリバースプロキシ設定

## 重要なファイル

### 設定ファイル
- `rails/config/routes.rb` - APIルーティング
- `rails/config/initializers/cors.rb` - CORS設定
- `rails/config/initializers/devise_token_auth.rb` - 認証設定
- `next/src/lib/client-auth.ts` - クライアント認証ユーティリティ
- `next/src/lib/server-auth.ts` - サーバー認証ユーティリティ

### 主要なバックエンドコントローラー
- `rails/app/controllers/api/v1/auth/sessions_controller.rb` - ログイン/ログアウト
- `rails/app/controllers/api/v1/running_records_controller.rb` - ランニング記録CRUD
- `rails/app/controllers/api/v1/running_statistics_controller.rb` - 統計計算
- `rails/app/controllers/api/v1/monthly_goals_controller.rb` - 月間目標管理
- `rails/app/controllers/api/v1/yearly_goals_controller.rb` - 年間目標管理

### 主要なフロントエンドコンポーネント
- `next/src/app/components/AuthWrapper.tsx` - 認証状態管理
- `next/src/app/components/ServerRunningDashboard.tsx` - メインダッシュボード
- `next/src/app/components/DashboardWithCalendar.tsx` - カレンダーとフォーム管理
- `next/src/app/components/RunningChart.tsx` - Chart.js可視化コンポーネント
- `next/src/app/components/ClientRunningCalendar.tsx` - インタラクティブカレンダー

## 開発時の注意事項

### Docker使用方法
- **重要**: 全ての開発作業はDockerコンテナ内で実行する
- ローカルでコマンドを実行せず、必ず `docker-compose exec [service] [command]` を使用する
- Railsサーバーは`0.0.0.0`にバインドする必要あり（Docker ネットワーク用）

**よくある間違い:**
- ❌ `cd rails && bundle exec rubocop` （ローカル実行）
- ✅ `docker-compose exec rails bundle exec rubocop` （Docker実行）

### コードスタイル
- Rails: RuboCop（Rails・RSpec設定）
- Next.js: ESLint（Next.js設定）
- 自動修正機能（Docker経由で実行）:
  - `docker-compose exec rails bundle exec rubocop -a`
  - `docker-compose exec next npm run format`

## トラブルシューティング

### 開発環境セットアップ
- node_modulesが空の場合、削除してからコンテナ内で`npm i`を実行
- RailsサーバーはDocker ネットワーク用に`-b '0.0.0.0'`フラグが必要
- CORS問題: `rails/config/initializers/cors.rb`で許可オリジンを確認

### 認証・API
- サーバーサイドAPIコールは`INTERNAL_API_URL`（host.docker.internal）を使用
- クライアントサイドAPIコールは`NEXT_PUBLIC_API_URL`（localhost）を使用
- 認証はHTTP-onlyクッキーに依存（localStorageではない）

### Chart.js・SSR
- Chart.jsコンポーネントはSSR問題回避のため動的インポートが必要
- SSR安全なチャートレンダリングにはRunningChartWrapperを使用

## ライセンス

このプロジェクトは開発中です。