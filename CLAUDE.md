# CLAUDE.md
å¿…ãšæ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Architecture Overview

This is a full-stack "Runmates" running management application with a Rails API backend and Next.js frontend, containerized with Docker. The system provides comprehensive running record tracking, goal setting, and data visualization features.

**Stack:**
- **Backend**: Rails API (Ruby 3.4.3) with MySQL 8.0.32
- **Frontend**: Next.js 15.3.1 with TypeScript, Tailwind CSS, MUI, and Chart.js
- **Authentication**: DeviseTokenAuth with HTTP-only cookies
- **Data Visualization**: Chart.js + react-chartjs-2 for modern charts
- **Deployment**: AWS ECS Fargate with Nginx reverse proxy

**Core Features:**
- Running record management with calendar interface
- Monthly and yearly goal setting and tracking
- Interactive data visualization with progress charts
- Responsive UI with modern design patterns

## Development Commands

### Initial Setup
```bash
# Clone and build containers
docker compose build --no-cache
docker compose up

# Frontend setup (in new terminal)
docker compose exec next /bin/bash
npm i
npm run dev  # Starts on localhost:8000

# Backend setup (in new terminal)
docker compose run --rm rails bundle install
docker compose exec rails /bin/bash
rails s -b '0.0.0.0'  # Starts on localhost:3000
```

### Daily Development

**é‡è¦: å…¨ã¦ã®ã‚³ãƒãƒ³ãƒ‰ã¯Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã—ã¦ãã ã•ã„**

```bash
# Frontend commands (DockerçµŒç”±ã§å®Ÿè¡Œ)
docker-compose exec next npm run dev          # Development server with Turbopack
docker-compose exec next npm run build        # Production build
docker-compose exec next npm run lint         # ESLint checking
docker-compose exec next npm run format       # Auto-fix linting issues

# Backend commands (DockerçµŒç”±ã§å®Ÿè¡Œ)
docker-compose exec rails rails s -b '0.0.0.0' # Start server (required for Docker)
docker-compose exec rails bundle exec rspec    # Run all tests
docker-compose exec rails bundle exec rspec spec/path/to/test_spec.rb  # Run single test
docker-compose exec rails bundle exec rubocop  # Code style checking
docker-compose exec rails rails db:migrate     # Run database migrations
docker-compose exec rails rails console        # Interactive console
```

### Testing
```bash
# Backend testing (Rails) - DockerçµŒç”±ã§å®Ÿè¡Œ
docker-compose exec rails bundle exec rspec                    # All tests
docker-compose exec rails bundle exec rspec spec/models/       # Model tests only
docker-compose exec rails bundle exec rspec spec/requests/     # Request/API tests only
docker-compose exec rails bundle exec rspec --format documentation  # Verbose output

# No frontend tests currently configured
```

## Key Architecture Patterns

### Authentication Flow
1. User submits credentials via React forms (SignInForm/SignUpForm)
2. Frontend sends requests to Rails API (`/api/v1/auth/`)
3. Rails validates and generates DeviseTokenAuth tokens
4. Rails sets HTTP-only cookies with `access-token`, `client`, and `uid`
5. Subsequent requests automatically include cookies
6. Rails validates tokens from cookies for protected routes

**Important**: Authentication uses cookies, not localStorage. Tokens are HTTP-only for XSS protection.

### API Structure
- All API endpoints under `/api/v1/` namespace
- Routes defined in `rails/config/routes.rb`
- Controllers in `rails/app/controllers/api/v1/`
- Serializers in `rails/app/serializers/` for JSON responses

### Frontend Structure
- Next.js App Router with TypeScript
- Authentication utilities split between:
  - `next/src/lib/client-auth.ts` - Client-side auth functions
  - `next/src/lib/server-auth.ts` - Server-side auth functions
- Forms use React Hook Form with validation
- AuthWrapper component handles authentication state

### Database
- MySQL database with comprehensive running management schema:
  - `users` - DeviseTokenAuth managed user accounts
  - `running_records` - Daily running distance records
  - `monthly_goals` - Monthly distance goals with year/month constraints
  - `yearly_goals` - Annual distance goals with unique constraints
- Database runs in Docker container on port 3307
- Migrations in `rails/db/migrate/`
- Test data factories in `rails/spec/factories/`

## Environment Configuration

### Development
- Rails server: localhost:3000
- Next.js frontend: localhost:8000
- MySQL database: localhost:3307
- Cookie settings: `same_site: :lax`, `secure: false`

**Environment Variables (.env.development):**
```bash
# Frontend
NEXT_PUBLIC_API_URL=http://localhost:3000/api/v1
INTERNAL_API_URL=http://host.docker.internal:3000/api/v1
NEXT_PUBLIC_BASE_URL=http://localhost:8000

# Backend (Rails)
MYSQL_DATABASE=runmates_development
DEVISE_SECRET_KEY=<auto-generated>
```

### Production
- Domain: `runmates.net`
- Cookie settings: `same_site: :none`, `secure: true`
- Deployed on AWS ECS Fargate
- Nginx reverse proxy configuration

## Important Files

### Configuration
- `rails/config/routes.rb` - API routing
- `rails/config/initializers/cors.rb` - CORS settings
- `rails/config/initializers/devise_token_auth.rb` - Auth configuration
- `next/src/lib/client-auth.ts` - Client authentication utilities
- `next/src/lib/server-auth.ts` - Server authentication utilities

### Backend Controllers
#### Authentication
- `rails/app/controllers/api/v1/auth/sessions_controller.rb` - Login/logout with cookie management
- `rails/app/controllers/api/v1/auth/registrations_controller.rb` - User registration

#### Running Management API
- `rails/app/controllers/api/v1/running_records_controller.rb` - CRUD for running records
- `rails/app/controllers/api/v1/running_statistics_controller.rb` - Statistics calculation
- `rails/app/controllers/api/v1/monthly_goals_controller.rb` - Monthly goals management
- `rails/app/controllers/api/v1/current_monthly_goals_controller.rb` - Current month goal API
- `rails/app/controllers/api/v1/yearly_goals_controller.rb` - Yearly goals management
- `rails/app/controllers/api/v1/current_yearly_goal_controller.rb` - Current year goal API

#### Models & Data
- `rails/app/models/running_record.rb` - Running record model with validations
- `rails/app/models/monthly_goal.rb` - Monthly goal model with scopes
- `rails/app/models/yearly_goal.rb` - Yearly goal model with constraints

### Key Frontend Components
#### Authentication
- `next/src/app/components/AuthWrapper.tsx` - Authentication state management
- `next/src/app/sign_in/SignInForm.tsx` - Login form
- `next/src/app/sign_up/SignUpForm.tsx` - Registration form
- `next/src/app/components/LogoutButton.tsx` - Logout functionality

#### Dashboard & Data Visualization
- `next/src/app/components/ServerRunningDashboard.tsx` - Main dashboard with statistics
- `next/src/app/components/DashboardWithCalendar.tsx` - Calendar and form management
- `next/src/app/components/RunningChart.tsx` - Chart.js visualization component
- `next/src/app/components/RunningChartWrapper.tsx` - SSR-safe chart wrapper

#### Running Management
- `next/src/app/components/ClientRunningCalendar.tsx` - Interactive calendar for date selection
- `next/src/app/components/ClientRecordForm.tsx` - Running record entry form
- `next/src/app/components/ClientGoalForm.tsx` - Monthly goal setting form
- `next/src/app/components/ClientYearlyGoalForm.tsx` - Yearly goal setting form

#### Server Actions & API Integration
- `next/src/app/actions/running-actions.ts` - Server actions for data mutations
- `next/src/lib/api.ts` - Client-side API utilities
- `next/src/lib/server-api.ts` - Server-side API utilities

## Development Notes

### ğŸš¨ å¿…é ˆãƒã‚§ãƒƒã‚¯é …ç›®ï¼ˆæ¯å›å®Ÿè¡Œï¼‰

**IMPORTANT: å…¨ã¦ã®å¤‰æ›´å¾Œã¯ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ã‚’å¿…ãšå®Ÿè¡Œã—ã¦ãã ã•ã„**

```bash
# 1. RSpecï¼ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‰
docker-compose exec rails bundle exec rspec

# 2. RuboCopï¼ˆã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ï¼‰
docker-compose exec rails bundle exec rubocop

# 3. ESLintï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒªãƒ³ãƒˆï¼‰
docker-compose exec next npm run lint
```

**è‡ªå‹•ä¿®æ­£ã‚‚åˆ©ç”¨å¯èƒ½:**
```bash
# RuboCopè‡ªå‹•ä¿®æ­£
docker-compose exec rails bundle exec rubocop -a

# ESLintè‡ªå‹•ä¿®æ­£
docker-compose exec next npm run format
```

### Docker Usage
- **é‡è¦**: å…¨ã¦ã®é–‹ç™ºä½œæ¥­ã¯Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã™ã‚‹
- ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã›ãšã€å¿…ãš `docker-compose exec [service] [command]` ã‚’ä½¿ç”¨ã™ã‚‹
- ã‚·ã‚§ãƒ«ã‚¢ã‚¯ã‚»ã‚¹: `docker-compose exec [service] /bin/bash`
- Rails server must bind to `0.0.0.0` (not localhost) for Docker networking
- Frontend and backend can be developed independently

**ã‚ˆãã‚ã‚‹é–“é•ã„:**
- âŒ `cd rails && bundle exec rubocop` (ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ)
- âœ… `docker-compose exec rails bundle exec rubocop` (Dockerå®Ÿè¡Œ)

### Authentication Debugging
- Sessions controller includes debug logging for token generation
- Check Rails logs for authentication flow debugging
- Cookies can be inspected in browser DevTools

### Code Style
- Rails: Uses RuboCop with Rails and RSpec configurations
- Next.js: Uses ESLint with Next.js configuration
- Both have auto-fix capabilities (DockerçµŒç”±ã§å®Ÿè¡Œ):
  - `docker-compose exec rails bundle exec rubocop -a`
  - `docker-compose exec next npm run format`

### Common Issues & Solutions

#### Development Setup
- If node_modules is empty, delete it and run `npm i` inside container
- Rails server requires `-b '0.0.0.0'` flag for Docker networking
- CORS issues: Check `rails/config/initializers/cors.rb` for allowed origins

#### Authentication & API
- Server-side API calls use `INTERNAL_API_URL` (host.docker.internal)
- Client-side API calls use `NEXT_PUBLIC_API_URL` (localhost)
- Authentication relies on HTTP-only cookies, not localStorage
- Check ApplicationController for cookie-to-header conversion logic

#### Chart.js & SSR
- Chart.js components must be dynamically imported to avoid SSR issues
- Use RunningChartWrapper for SSR-safe chart rendering
- EmotionCache is configured in ThemeRegistry for Material-UI consistency

#### Database & Migrations
- Ensure proper database constraints are applied via migrations
- Use `rails db:migrate` after pulling new migration files
- Check `rails/db/schema.rb` for current database structure